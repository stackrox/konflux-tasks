apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: install-infractl
spec:
  description: Download infractl.
  results:
  - name: infractl-bin
    description: Path to the infractl binary.
  steps:
  - name: donwload-infractl
    image: registry.access.redhat.com/ubi9-minimal:latest@sha256:66b99214cb9733e77c4a12cc3e3cbbe76769a213f4e2767f170a4f0fdf9db490
    workingDir: /workspace/bin
    script: |
      #!/usr/bin/env bash

      set -o errexit
      set -o nounset
      set -o pipefail
      
      curl --fail -sL https://infra.rox.systems/v1/cli/linux/amd64/upgrade \
        | jq -r ".result.fileChunk" \
        | base64 -d \
      > infractl
      chmod +x infractl
      printf "INFO: $(./infractl --version)\n" 
      echo "/workspace/bin/infractl" > $(results.infractl-bin.path)
